@model IEnumerable<PennyWise.ViewModels.ExpenseListItemViewModel>
@{
    ViewData["Title"] = "Expenses";
    var currency = ViewBag.CurrencySymbol as string ?? "$";
    var month = ViewBag.Month ?? DateTime.Now.Month;
    var year = ViewBag.Year ?? DateTime.Now.Year;
    var monthName = System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(month);
}

<!-- Modern Month Selector Bar with Add Button -->
<div class="glass-card month-selector-card mb-3 mb-md-4 p-2 p-md-3">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 gap-md-3">
        <!-- Month Display & Selector -->
        <div class="d-flex align-items-center gap-2 w-100 w-md-auto">
            <button class="btn btn-glass btn-sm px-2" onclick="navigateMonth(-1)">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                </svg>
            </button>
            
            <div class="dropdown month-dropdown-container flex-grow-1 flex-md-grow-0">
                <button class="btn btn-glass dropdown-toggle w-100 text-start d-flex justify-content-between align-items-center" style="min-width: 160px;" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="fw-medium">@monthName @year</span>
                </button>
                <ul class="dropdown-menu month-dropdown-menu">
                    @for (int i = 1; i <= 12; i++)
                    {
                        var isFuture = (year == DateTime.Now.Year && i > DateTime.Now.Month) || (year > DateTime.Now.Year);
                        if (!isFuture)
                        {
                            <li>
                                <a class="dropdown-item text-white @(i == month ? "active" : "")" href="javascript:void(0)" onclick="updatePageContent('@Url.Action("Index", "Expense")?month=@i&year=@year')">
                                    @System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(i)
                                </a>
                            </li>
                        }
                    }
                </ul>
            </div>
            
            <button class="btn btn-glass btn-sm px-2" onclick="navigateMonth(1)" @(year == DateTime.Now.Year && month == DateTime.Now.Month ? "disabled" : "")>
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                </svg>
            </button>
        </div>
        
        <!-- Add Expense Button (Desktop Only) -->
        <a asp-action="Create" class="btn btn-modern btn-primary-glow btn-sm d-none d-md-inline-flex align-items-center">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-1">
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
            </svg>
            <span>Add Expense</span>
        </a>
    </div>
</div>

<!-- Expenses Table -->
<div class="glass-card">
    <div class="d-flex justify-content-between align-items-center mb-3 mb-md-4">
        <h5 class="mb-0 fw-bold">Expense History</h5>
        <span class="chip chip-neutral">@Model.Count() @(Model.Count() == 1 ? "Item" : "Items")</span>
    </div>
    
    <div class="table-responsive">
        <table class="modern-table w-100">
            <thead>
                <tr>
                    <th class="d-none d-md-table-cell" style="width: 15%;">Date</th>
                    <th style="width: 25%;">Category</th>
                    <th style="width: 20%;" class="text-end">Amount</th>
                    <th class="d-none d-sm-table-cell">Description</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var e in Model)
                {
                    <tr>
                        <td class="text-muted small d-none d-md-table-cell">@e.Date.ToString("MMM dd, yyyy")</td>
                        <td>
                            <span class="chip chip-neutral" style="font-size: 0.75rem;">@e.CategoryName</span>
                            <div class="d-md-none text-muted small mt-1">@e.Date.ToString("MMM dd")</div>
                        </td>
                        <td class="text-end fw-bold text-danger">@string.Format("{0}{1:N0}", currency, e.Amount)</td>
                        <td class="text-muted d-none d-sm-table-cell" style="font-size: 0.875rem;">
                            @if (!string.IsNullOrEmpty(e.Description))
                            {
                                @(e.Description.Length > 50 ? e.Description.Substring(0, 50) + "..." : e.Description)
                            }
                            else
                            {
                                <span class="text-muted fst-italic">-</span>
                            }
                        </td>
                    </tr>
                }
                @if (!Model.Any())
                {
                    <tr>
                        <td colspan="4" class="text-center py-5 text-muted">
                            <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16" class="mb-3" style="opacity: 0.3;">
                                <path d="M1.5 1a.5.5 0 0 0-.5.5v3a.5.5 0 0 1-1 0v-3A1.5 1.5 0 0 1 1.5 0h3a.5.5 0 0 1 0 1h-3zM11 .5a.5.5 0 0 1 .5-.5h3A1.5 1.5 0 0 1 16 1.5v3a.5.5 0 0 1-1 0v-3a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 1-.5-.5zM.5 11a.5.5 0 0 1 .5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 1 0 1h-3A1.5 1.5 0 0 1 0 14.5v-3a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v3a1.5 1.5 0 0 1-1.5 1.5h-3a.5.5 0 0 1 0-1h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 1 .5-.5z"/>
                                <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                            </svg>
                            <div>No expenses recorded for @monthName @year</div>
                            <!-- Hide this duplicate button on mobile if FAB is present, or keep as alternative for empty state -->
                            <a asp-action="Create" class="btn btn-modern btn-primary-glow btn-sm mt-3 d-none d-md-inline-block">
                                Add Your First Expense
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Floating Add Button (Mobile Only) -->
<!-- Floating Add Button (Mobile Only) -->
<a href="@Url.Action("Create", "Expense")" class="btn-fab d-md-none" aria-label="Add Expense">
    <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
    </svg>
</a>

<script>
    function navigateMonth(direction) {
        var currentMonth = @month;
        var currentYear = @year;
        var now = new Date();
        
        var newMonth = currentMonth + direction;
        var newYear = currentYear;
        
        if (newMonth > 12) {
            newMonth = 1;
            newYear++;
        } else if (newMonth < 1) {
            newMonth = 12;
            newYear--;
        }
        
        // Prevent future months
        if (newYear > now.getFullYear() || (newYear === now.getFullYear() && newMonth > (now.getMonth() + 1))) {
            return;
        }
        
        updatePageContent('@Url.Action("Index", "Expense")?month=' + newMonth + '&year=' + newYear);
    }
</script>
